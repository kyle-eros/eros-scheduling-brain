config {
  type: "assertion",
  schema: "eros_assertions",
  name: "mass_messages_unique_key"
}

-- Fail if duplicate message_sk exists in the last 14 days
SELECT message_sk
FROM ${ref("mass_messages")}
WHERE sending_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 14 DAY)
GROUP BY message_sk
HAVING COUNT(*) > 1