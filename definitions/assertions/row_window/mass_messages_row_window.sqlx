config {
  type: "assertion",
  schema: "eros_assertions",
  description: "mass_messages: no duplicates after ROW_NUMBER() on 14 days",
  tags: ["data_quality","row_window"]
}

WITH ranked AS (
  SELECT
    message_sk,
    loaded_at,
    ROW_NUMBER() OVER (PARTITION BY message_sk ORDER BY loaded_at DESC) AS rn
  FROM ${ref("mass_messages")}
  WHERE sending_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 14 DAY)
)
SELECT *
FROM ranked
WHERE rn > 1
