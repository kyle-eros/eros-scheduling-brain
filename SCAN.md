# Phase 1 - Quick Diagnostic Results

## Autogenerated Assertions for eros_messaging_stg.mass_messages

**Found 2 autogenerated assertions:**
1. `eros_messaging_stg_mass_messages_assertions_uniqueKey_0`
2. `eros_messaging_stg_mass_messages_assertions_rowConditions`

**Issue:** Neither assertion includes positive partition predicates like `WHERE sending_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 14 DAY)`. They query the entire table which violates BigQuery partition filter requirements.

**SQL Analysis:**
- uniqueKey assertion: `SELECT * FROM mass_messages GROUP BY message_sk` (NO partition filter)
- rowConditions assertion: `SELECT * FROM mass_messages WHERE NOT (...)` (NO partition filter)

## File Analysis

### ✅ definitions/messaging/feat/authenticity_monitor.sqlx
**Status: FOUND ISSUES**
- **Window function in aggregate:** Line 23 has `AVG(COUNT(*)) OVER (...)` - this is a window function used inside an aggregate context
- **Column reference:** Uses `me.username_std` correctly (not `page_handle`)
- **Operator usage:** Uses `MOD()` correctly on line 55 (not % operator)

### ❌ definitions/messaging/feat/tier_baseline_templates.sqlx  
**Status: STRUCT INCONSISTENCY ISSUES**
- **Problem:** Arrays contain STRUCT elements with different field counts and structures:
  - `drip_schedule`: 5 fields (label, base_time, template_type, hour, randomize_minutes)
  - `renewal_schedule`: 5 fields (label, base_time, template_type, hour, randomize_minutes)  
  - `ppv_windows`: 4 fields (label, time_range, price_type, hours)
- **Expected:** All STRUCT elements should have identical 8 fields including `tier_id`, `tier_name`, `page_type`, etc.

### ✅ definitions/messaging/mart/caption_rank_next24_v3_tbl.sqlx
**Status: CLEAN**
- **Partition spec:** Consistent - `partitionBy: "slot_dt_local"` and `slot_dt_local` is in final SELECT
- **Cluster columns:** Both `username_page` and `hod` exist in final SELECT
- **No issues found**

## Summary

**Critical Issues:**
1. Autogenerated assertions lack partition filters (will cause BigQuery errors)
2. Window function used inside aggregate in authenticity_monitor.sqlx
3. STRUCT field inconsistency in tier_baseline_templates.sqlx arrays

**Clean Files:**
- caption_rank_next24_v3_tbl.sqlx (no changes needed)